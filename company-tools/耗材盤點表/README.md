# 耗材盤點表系統

## 系統概述
杰特企業有限公司的耗材盤點管理系統，用於追蹤辦公室和倉庫耗材的庫存狀態、採購流程和補貨週期。

---

## 更新紀錄

### 2026-01-23 更新（二）
**新增待處理提醒功能**

#### 1. 頁面內提醒
- 進入盤點表時，如果有超時未處理的項目會彈窗提醒
- 每天只提醒一次（點「我知道了」後當天不再顯示）
- 點「稍後提醒」下次刷新頁面還會顯示

#### 2. 每日 Email 提醒
- 每天自動發送待採購清單到指定信箱
- 超時項目會特別標示
- 支援多人收件（逗號分隔）

#### 3. 系統設定工作表
所有提醒設定都在 Google Sheets「系統設定」工作表中管理：

| 設定項目 | 說明 | 範例值 |
|---------|------|--------|
| 提醒信箱 | 收件人，多人用逗號分隔 | a@gmail.com, b@gmail.com |
| 提醒時間 | 每天幾點發送（24小時制） | 09:00 |
| 超時天數 | 超過幾天未處理才提醒 | 2 |
| 啟用Email提醒 | 是否發送 Email | TRUE / FALSE |
| 啟用頁面提醒 | 是否顯示彈窗 | TRUE / FALSE |

#### 設定步驟
1. 在 Apps Script 編輯器執行 `initSystemSettings()` 創建設定表
2. 在「系統設定」工作表填寫提醒信箱等設定
3. 執行 `setupDailyTrigger()` 設定每日自動發送
4. 執行 `testSendReminder()` 測試發送

---

### 2026-01-23 更新（一）
**項目清單改由 Google Sheets 管理 + 優化彈窗 UI + 修正頻率邏輯**

#### 1. 項目清單管理
- 項目清單從 `script.js` 硬編碼改為存放在 Google Sheets「項目清單」工作表
- 「確認移除」功能會真正從項目清單刪除項目
- 第一次使用時會自動創建「項目清單」工作表並寫入預設項目
- 統計數據會排除已移除的項目

#### 2. 彈窗 UI 優化
- 「確認移除」「取消採購」「標記異常」改用選項彈窗，不再用 prompt()
- 姓名輸入改用統一風格彈窗，並記住上次輸入的姓名
- 所有彈窗支援點選預設選項或自訂輸入

#### 3. 頻率判斷邏輯修正（重要）
**只有當以下條件全部滿足時，才使用系統建議的頻率：**
- 平均補貨天數有值（avgReplenishDays）
- 平均叫貨間隔有值（avgOrderInterval）
- 至少有 3 次完整補貨記錄（completedOrders >= 3）

**否則使用「項目清單」工作表中手動設定的頻率。**

這樣確保只有足夠的數據才會覆蓋手動設定。

---

### 2026-01-22 更新
**建議頻率邏輯改為基於「叫貨間隔」**

修改 `GoogleAppsScript.gs` 中的 `getStatistics` 函數：
- **舊邏輯**：基於「補貨等待天數」（從叫貨到收貨的時間）
- **新邏輯**：基於「叫貨間隔」（多久需要叫一次貨）

| 叫貨間隔 | 意義 | 建議頻率 |
|---------|------|---------|
| ≤ 7 天 | 消耗很快，每週或更短就要叫一次 | 🔴 每日盤點 |
| 8-30 天 | 消耗中等，一個月內會叫貨 | 🔵 每週盤點 |
| > 30 天 | 消耗慢，超過一個月才叫一次 | 🟢 每月盤點 |

新增欄位 `avgOrderInterval`（平均叫貨間隔）在統計資料中。

---

## 系統功能

### 1. 盤點頁面（📋 盤點）
- **基本資訊**：盤點日期、盤點人員
- **項目分類**：
  - 🖊️ 辦公室區域（阿駿負責）
  - 📦 倉庫區（阿駿負責）
  - 🎨 倉庫貼紙盤點（負責人：美編）
  - 📮 OPP袋子盤點（負責人：秀娟）

#### 項目狀態選項
| 狀態 | 說明 | 顏色 |
|------|------|------|
| 不用叫貨 | 庫存充足 | 藍色 |
| 要叫貨 | 庫存不足，需採購 | 藍色 |
| 補貨中 | 已叫貨，等待到貨 | 橙色 |
| 已補貨 | 貨已到，完成補貨 | 綠色 |

#### 今日盤點建議（自動判斷）
系統根據當日自動決定需盤點的項目：
- **一般日**：只盤每日項目（🔴）
- **週一**：盤每日 + 每週項目（🔴🔵）
- **每月1號**：盤全部項目（🔴🔵🟢）

### 2. 採購追蹤頁面（🛒 採購追蹤）
追蹤從「要叫貨」到「已補貨」的完整流程。

#### 篩選功能
- 全部
- 待採購
- 補貨中
- ⚠️ 超時（超過警告天數未處理）
- 🚫 異常（標記為異常的項目）

#### 超時警告
- 🟡 黃色警告：超過 2 天未處理
- 🔴 紅色警告：超過 3 天未處理
- 🟣 紫色：標記為異常

#### 異常標記功能
- 可標記長期無法補貨的項目為「異常」
- 異常項目會從正常流程中分離
- 記錄異常總天數

#### 操作彈窗預設選項
所有操作都使用統一風格的選項彈窗，可直接點選或自訂輸入：

| 功能 | 預設選項 |
|------|---------|
| 🗑️ 確認移除 | 已停用、不再需要、重複項目、規則調整、項目合併、庫存清空不再進貨 |
| ❌ 取消採購 | 規則調整、庫存充足、安全庫存設太高、重複叫貨、暫時不需要、供應商缺貨改其他 |
| 🚫 標記異常 | 長期缺貨、供應商問題、品質異常、價格異常、暫停使用、待確認規格 |

如需修改預設選項，請編輯 `script.js` 中的 `showReasonDialog()` 呼叫處。

### 3. 數據儀表板（📊 數據儀表板）
顯示補貨分析統計：
- 總項目數
- 建議每日盤點數
- 建議每週盤點數
- 建議每月盤點數
- 異常項目數
- 各項目的叫貨次數、平均補貨天數、異常天數

---

## 盤點頻率規則（核心邏輯）

### 頻率判斷優先順序

```
┌─────────────────────────────────────────────────────────────┐
│  系統如何決定一個項目的盤點頻率？                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 檢查是否有足夠的統計數據：                                │
│     ├─ 平均補貨天數（avgReplenishDays）有值？                │
│     ├─ 平均叫貨間隔（avgOrderInterval）有值？                │
│     └─ 完整補貨記錄 >= 3 次？                                │
│                                                             │
│  2. 三個條件都滿足 → 使用【系統建議頻率】                     │
│     任一條件不滿足 → 使用【項目清單手動設定的頻率】            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 手動設定頻率（項目清單工作表）
在 Google Sheets「項目清單」工作表中設定：

| 分類 | 名稱 | 閾值說明 | 單位 | 警告數量 | 盤點頻率 |
|------|------|---------|------|---------|---------|
| warehouse | MO+店貼紙 | 剩一綑就要叫 | 綑 | 1 | monthly |

可用的頻率值：`daily`（每日）、`weekly`（每週）、`monthly`（每月）

### 系統建議頻率（自動計算）
當有足夠數據（3次以上完整補貨記錄）時，系統根據叫貨間隔自動建議：

| 平均叫貨間隔 | 意義 | 建議頻率 |
|-------------|------|---------|
| ≤ 7 天 | 消耗很快，每週或更短就要叫一次 | 🔴 每日盤點 |
| 8-30 天 | 消耗中等，一個月內會叫貨 | 🔵 每週盤點 |
| > 30 天 | 消耗慢，超過一個月才叫一次 | 🟢 每月盤點 |

### 相關程式碼位置
- **後端判斷邏輯**：`GoogleAppsScript.gs` → `getStatistics()` 函數
- **前端取得頻率**：`script.js` → `getItemFrequency()` 函數

---

## 手機版功能

### 滑動模式
- 一次顯示一個項目，方便手機操作
- 分類 Tab 快速切換：辦公室、倉庫區、貼紙、OPP袋
- 進度條顯示完成狀態
- 上一項/下一項導航按鈕
- 第一項/最後一項快速跳轉

### 手機版今日建議
顯示當日應盤點的頻率和項目數量

---

## 多語言支援

支援兩種語言：
- 🇹🇼 中文（預設）
- 🇮🇩 Indonesia（印尼語）

切換方式：點擊頁面右上角的語言按鈕

---

## 技術架構

### 前端
- `index.html`：主頁面結構和樣式
- `script.js`：前端邏輯、項目資料、多語言翻譯

### 後端
- `GoogleAppsScript.gs`：Google Apps Script，處理資料存取

### Google Sheets 工作表
| 工作表名稱 | 用途 |
|-----------|------|
| **項目清單** | 盤點項目的主資料（分類、名稱、閾值、單位、警告數量、頻率） |
| 最新狀態 | 每個項目的最新盤點狀態 |
| 盤點歷史 | 所有盤點記錄的完整歷史 |
| 盤點摘要 | 每次盤點的統計摘要 |
| 待採購 | 採購追蹤（含時間戳記和補貨天數） |
| 異常記錄 | 異常標記的歷史記錄 |

#### 項目清單工作表欄位
| 欄位 | 說明 | 範例 |
|------|------|------|
| 分類 | 項目分類代碼 | ajun / warehouse / meiban / xiujuan |
| 名稱 | 項目名稱 | 大膠帶 |
| 閾值說明 | 何時需要叫貨的說明 | 剩五條就要買 |
| 單位 | 計量單位 | 條 |
| 警告數量 | 低於此數量需叫貨 | 5 |
| 盤點頻率 | 手動設定的頻率 | daily / weekly / monthly |

---

## API 端點

### GET 請求
| action | 說明 |
|--------|------|
| `getLastInventory` | 取得上次盤點資料 |
| `getPurchaseList` | 取得待採購清單 |
| `getStatistics` | 取得統計數據和建議頻率 |
| `getReplenishHistory` | 取得特定項目的補貨歷史 |
| `getDisabledItems` | 取得被停用（異常/已移除）的項目 |
| `getInventoryItems` | 取得項目清單（從 Google Sheets） |

### POST 請求
| action | 說明 |
|--------|------|
| `submitInventory` | 提交盤點資料 |
| `updatePurchaseStatus` | 更新採購狀態（補貨中/已補貨） |
| `markAbnormal` | 標記/取消標記項目為異常 |
| `removeItem` | 確認移除項目（從項目清單刪除） |
| `cancelPurchase` | 取消本次採購 |
| `initInventoryItems` | 初始化項目清單到 Google Sheets |

---

## 項目清單

### 辦公室區域（21項）
蝸牛、攝影機、小膠帶台、大膠帶台、新人制服、紅筆、藍筆、奇異筆、美工刀、大刀片、小刀片、剪刀、大膠帶、細膠帶、紙膠帶、燈泡、A4紙、碳粉、衛生紙、桶裝水、電池

### 倉庫區（13項）
MO+店貼紙、倉庫推車標示單、棧板出貨標示單、酒精、大紙箱、中紙箱、15×15×15紙盒、10×15×4小飛機盒、18×11×6中飛機盒、26.5×19×6.5大飛機盒、防撞角、氣泡紙、PDA 6×4條碼貼紙

### 倉庫貼紙（6項）
小防撕貼、中防撕貼、大防撕貼、寄倉貼紙、備貨貼紙、地球貼

### OPP袋子（41項）
破壞袋 8款 + OPP袋 33款

---

## 使用流程

### 日常盤點流程
1. 選擇盤點日期和人員
2. 系統自動顯示今日應盤點的項目
3. 逐一檢查項目，選擇狀態
4. 點擊「查看要叫貨的項目」確認
5. 點擊「提交盤點表」上傳資料

### 採購追蹤流程
1. 盤點時標記「要叫貨」→ 自動進入採購追蹤
2. 叫貨後標記「補貨中」
3. 貨到後標記「已補貨」
4. 系統自動計算補貨天數

### 異常處理流程
1. 項目超時未處理會顯示警告
2. 長期無法補貨可標記為「異常」
3. 異常項目會累計異常天數
4. 問題解決後可取消異常標記

---

## 注意事項

1. **每日必盤項目**：大膠帶、細膠帶、大紙箱、中紙箱、氣泡紙（消耗快）
2. **每月盤點項目**：攝影機、新人制服、燈泡、地球貼（消耗慢）
3. **提交前確認**：系統會顯示狀態變更的項目，請確認無誤
4. **手機使用**：建議使用滑動模式，操作更方便

---

## 傻瓜式操作指南（完整教學）

### 📱 頁面上方按鈕說明

| 按鈕 | 功能 | 什麼時候用 |
|------|------|-----------|
| 📋 盤點 | 切換到盤點頁面 | 要做每日盤點時 |
| 🛒 採購追蹤 | 切換到採購追蹤頁面 | 要看哪些東西要買、在補貨中 |
| 📊 數據儀表板 | 切換到統計分析頁面 | 要看補貨數據分析 |
| 🌐 語言切換 | 切換中文/印尼語 | 給外籍同事看 |

---

### 📋 盤點頁面按鈕說明

#### 頂部區域
| 欄位/按鈕 | 功能 | 怎麼用 |
|----------|------|--------|
| 盤點日期 | 選擇今天日期 | 點一下選日期，通常就是今天 |
| 盤點人員 | 填你的名字 | 打你的名字，之後會自動記住 |

#### 頻率篩選按鈕
| 按鈕 | 功能 |
|------|------|
| 📦 全部 | 顯示所有項目 |
| 📅 今日建議 | 只顯示今天應該盤的項目（系統自動判斷） |
| 🔴 每日 | 只顯示每天都要盤的項目 |
| 🔵 每週 | 只顯示每週盤的項目 |
| 🟢 每月 | 只顯示每月盤的項目 |

#### 每個項目的選項
| 選項 | 意思 | 什麼時候選 |
|------|------|-----------|
| ⚪ 不用叫貨 | 庫存還夠 | 數量還很多，不需要買 |
| ⚪ 要叫貨 | 庫存不夠了 | 數量低於警戒線，需要採購 |
| ⚪ 補貨中 | 已經叫了，等貨到 | 已經下單，貨還沒到 |
| ⚪ 已補貨 | 貨已經到了 | 貨已經收到並入庫 |

#### 底部按鈕
| 按鈕 | 功能 | 怎麼用 |
|------|------|--------|
| 📝 查看要叫貨的項目 | 預覽這次盤點結果 | 提交前先看一下有哪些要買 |
| ✅ 提交盤點表 | 把盤點結果上傳到系統 | 確認無誤後點這個，就完成了 |

---

### 🛒 採購追蹤頁面按鈕說明

#### 篩選按鈕
| 按鈕 | 功能 |
|------|------|
| 全部 | 顯示所有採購項目 |
| 待採購 | 只顯示還沒叫貨的 |
| 補貨中 | 只顯示已叫貨、等到貨的 |
| ⚠️ 超時 | 只顯示超過天數沒處理的（預設 2 天） |
| 🚫 異常 | 只顯示被標記異常的項目 |

#### 每個項目的操作按鈕
| 按鈕 | 功能 | 什麼時候用 |
|------|------|-----------|
| 📦 補貨中 | 標記為已下單 | 你已經叫貨了，在等貨到 |
| ✅ 已補貨 | 標記為貨已到 | 貨已經收到並入庫 |
| 🚫 標記異常 | 標記為異常狀態 | 長期缺貨、供應商問題等 |
| ↩️ 取消異常 | 取消異常標記 | 問題解決了，恢復正常追蹤 |
| ❌ 取消採購 | 取消這次採購 | 不需要買了（規則設太高、庫存夠了） |
| 🗑️ 確認移除 | 永久刪除這個項目 | 這個東西以後都不用盤了 |

#### 操作時的彈窗選項

**🗑️ 確認移除 - 選擇原因：**
- 已停用
- 不再需要
- 重複項目
- 規則調整
- 項目合併
- 庫存清空不再進貨

**❌ 取消採購 - 選擇原因：**
- 規則調整
- 庫存充足
- 安全庫存設太高
- 重複叫貨
- 暫時不需要
- 供應商缺貨改其他

**🚫 標記異常 - 選擇原因：**
- 長期缺貨
- 供應商問題
- 品質異常
- 價格異常
- 暫停使用
- 待確認規格

---

### 📊 數據儀表板說明

#### 頂部摘要卡片
| 卡片 | 意思 |
|------|------|
| 總項目數 | 有統計數據的項目總數 |
| 建議每日盤 | 根據消耗速度，建議每天盤的數量 |
| 建議每週盤 | 根據消耗速度，建議每週盤的數量 |
| 建議每月盤 | 根據消耗速度，建議每月盤的數量 |
| 異常項目 | 被標記異常的項目數量 |

#### 表格欄位說明
| 欄位 | 意思 |
|------|------|
| 項目 | 耗材名稱 |
| 叫貨次數 | 這個東西歷史上叫過幾次貨 |
| 平均補貨天數 | 從叫貨到收貨平均要幾天 |
| 平均叫貨間隔 | 平均多久要叫一次貨 |
| 建議頻率 | 系統根據數據建議的盤點頻率 |
| 異常天數 | 累計被標記異常的總天數 |
| 目前狀態 | 這個項目現在的狀態 |

---

### ⚙️ Google Sheets 管理指南

#### 工作表說明（打開 Google Sheets 會看到這些分頁）

| 工作表名稱 | 用途 | 可以改嗎 |
|-----------|------|---------|
| **項目清單** | 所有要盤點的項目 | ✅ 可以新增/修改/刪除項目 |
| **系統設定** | 提醒通知的設定 | ✅ 可以改信箱、時間等 |
| 最新狀態 | 系統自動記錄 | ❌ 不要動 |
| 盤點歷史 | 系統自動記錄 | ❌ 不要動 |
| 盤點摘要 | 系統自動記錄 | ❌ 不要動 |
| 待採購 | 系統自動記錄 | ❌ 不要動 |
| 異常記錄 | 系統自動記錄 | ❌ 不要動 |

#### 如何新增盤點項目

1. 打開 Google Sheets
2. 點「項目清單」分頁
3. 在最下面新增一列，填寫：

| 分類 | 名稱 | 閾值說明 | 單位 | 警告數量 | 盤點頻率 |
|------|------|---------|------|---------|---------|
| warehouse | 新東西名稱 | 剩X個就要叫 | 個 | 2 | weekly |

**分類代碼對照：**
- `ajun` = 辦公室區域
- `warehouse` = 倉庫區
- `meiban` = 倉庫貼紙
- `xiujuan` = OPP袋子

**盤點頻率：**
- `daily` = 每天都要盤
- `weekly` = 每週盤一次
- `monthly` = 每月盤一次

4. 存檔後，刷新盤點表頁面就會看到新項目

#### 如何修改提醒設定

1. 打開 Google Sheets
2. 點「系統設定」分頁
3. 直接修改「設定值」欄位：

| 設定項目 | 怎麼改 |
|---------|--------|
| 提醒信箱 | 填 Email，多人用逗號分隔 |
| 提醒時間 | 填 24 小時制時間，例如 09:00 |
| 超時天數 | 填數字，例如 2 表示超過 2 天提醒 |
| 啟用Email提醒 | 填 TRUE 或 FALSE |
| 啟用頁面提醒 | 填 TRUE 或 FALSE |

4. 存檔就生效了（不需要重新部署）

---

### 🔧 首次設定步驟（給管理員）

#### 步驟 1：創建系統設定表
1. 打開 Google Sheets
2. 點「擴充功能」→「Apps Script」
3. 在左邊找到 `initSystemSettings`
4. 點上方的「執行」按鈕
5. 回到 Google Sheets，會看到新的「系統設定」分頁

#### 步驟 2：填寫提醒設定
1. 點「系統設定」分頁
2. 在「提醒信箱」填上所有要收通知的人的 Email
3. 其他設定可以先用預設值

#### 步驟 3：設定每日自動發送
1. 回到 Apps Script
2. 找到 `setupDailyTrigger`
3. 點「執行」
4. 如果要求授權，點「審查權限」→「進階」→「前往」→「允許」

#### 步驟 4：測試發送
1. 找到 `testSendReminder`
2. 點「執行」
3. 去收件匣看有沒有收到測試信

#### 常見問題：Email 發送失敗
如果看到「You do not have permission」錯誤：
1. 點「執行」任何一個函數
2. 會彈出「需要授權」
3. 點「審查權限」→ 選擇你的帳號
4. 點「進階」→「前往 XXX（不安全）」
5. 點「允許」
6. 再執行一次就可以了

---

### 🆘 出問題怎麼辦？

| 問題 | 解決方法 |
|------|---------|
| 頁面空白/載入失敗 | 檢查網路連線，重新整理頁面 |
| 新增的項目沒出現 | 刷新頁面（Ctrl+F5 或手機下拉刷新） |
| Email 沒收到 | 檢查「系統設定」的信箱有沒有打對、垃圾郵件匣 |
| 頻率設定沒生效 | 如果有超過 3 次補貨記錄，系統會用建議頻率覆蓋 |
| 按鈕點了沒反應 | 可能網路慢，等一下或重新整理 |

---

### 📞 系統維護聯絡

如果系統出問題需要修改程式碼，請聯絡 IT 人員。

**重要檔案位置：**
- 前端程式碼：`script.js`
- 後端程式碼：`GoogleAppsScript.gs`（在 Google Sheets 的 Apps Script 裡）
- 說明文件：`README.md`（就是這份文件）
