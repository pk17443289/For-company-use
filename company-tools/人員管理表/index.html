<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人員排班系統 - 24小時管理</title>
    <link rel="stylesheet" href="style.css?v=2.0">
</head>
<body>
    <!-- 動態網格背景 -->
    <div class="cyber-bg"></div>

    <div class="container">
        <!-- 標題區 -->
        <header class="cyber-header">
            <h1 class="glitch">人員排班系統</h1>
            <div class="subtitle">24/7 PERSONNEL MANAGEMENT</div>
        </header>

        <!-- 主控制面板 -->
        <div class="control-panel">
            <!-- 日期選擇器 -->
            <div class="date-selector-panel">
                <div class="panel-title collapsible-title" data-target="dateContent">
                    <span class="bracket">[</span>
                    日期選擇
                    <span class="bracket">]</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div id="dateContent" class="collapsible-content">
                <div class="date-quick-btns">
                    <button class="date-btn active" data-offset="0" onclick="switchDate(0)">📅 今天</button>
                    <button class="date-btn" data-offset="1" onclick="switchDate(1)">➡️ 明天</button>
                    <button class="date-btn" data-mode="custom" onclick="openDatePicker()">🗓️ 選擇日期</button>
                </div>
                <!-- 隱藏的日期選擇器，用於觸發系統日曆 -->
                <input type="date" id="customDate" class="cyber-date-input" style="position: absolute; opacity: 0;" onchange="onCustomDateChange(this.value)">
                <div class="current-date-display">
                    <span class="date-label">查詢日期：</span>
                    <span id="currentDateDisplay" class="date-value">2025-01-18 (今天)</span>
                </div>
                <div class="schedule-overview">
                    <div class="overview-title">📅 快速切換日期</div>
                    <select id="scheduleOverview" class="schedule-select"></select>
                </div>
                </div>
            </div>

            <!-- 時段選擇器 -->
            <div class="time-selector-panel">
                <div class="panel-title collapsible-title" data-target="timeContent">
                    <span class="bracket">[</span>
                    時段選擇
                    <span class="bracket">]</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div id="timeContent" class="collapsible-content">
                <div class="time-quick-btns">
                    <button class="time-btn active" data-mode="now">🕐 現在</button>
                    <button class="time-btn" data-mode="night">🌙 凌晨 00-06</button>
                    <button class="time-btn" data-mode="morning">🌅 早上 06-12</button>
                    <button class="time-btn" data-mode="afternoon">☀️ 下午 12-18</button>
                    <button class="time-btn" data-mode="evening">🌆 晚上 18-00</button>
                    <button class="time-btn" data-mode="custom">⚙️ 自訂</button>
                </div>
                <div class="time-custom-range hidden">
                    <div class="range-inputs">
                        <div class="range-group">
                            <label>開始</label>
                            <input type="number" id="startHour" min="0" max="23" value="8" class="cyber-input-small">
                            <span class="unit">時</span>
                        </div>
                        <span class="separator">→</span>
                        <div class="range-group">
                            <label>結束</label>
                            <input type="number" id="endHour" min="0" max="23" value="17" class="cyber-input-small">
                            <span class="unit">時</span>
                        </div>
                        <button id="applyCustomTime" class="apply-btn">套用</button>
                    </div>
                </div>
                <div class="current-time-display">
                    <span class="time-label">查詢時段：</span>
                    <span id="currentTimeDisplay" class="time-value">現在</span>
                </div>
                </div>
            </div>

            <!-- 快速篩選與搜尋 -->
            <div class="filter-panel-simple">
                <div class="filter-btns-simple">
                    <button class="filter-btn active" data-filter="all">全部</button>
                    <button class="filter-btn status-free" data-filter="free">空閒</button>
                    <button class="filter-btn status-busy" data-filter="busy">忙碌</button>
                    <button class="filter-btn status-leave" data-filter="leave">🏖️ 請假</button>
                    <button class="filter-btn status-mission" data-filter="mission">🚀 出任務</button>
                    <button class="filter-btn status-lunch" data-filter="lunch">🍱 午休</button>
                    <button class="filter-btn status-comp-leave" data-filter="comp_leave">⏰ 補休</button>
                </div>
                <select id="departmentFilter" class="rank-select-simple">
                    <option value="all">所有部門</option>
                </select>
                <select id="rankFilter" class="rank-select-simple">
                    <option value="all">所有階級</option>
                    <option value="9-10">⭐⭐⭐ 高階 (9-10)</option>
                    <option value="7-8">⭐⭐ 中高階 (7-8)</option>
                    <option value="5-6">⭐ 中階 (5-6)</option>
                    <option value="3-4">基層 (3-4)</option>
                    <option value="1-2">新進 (1-2)</option>
                    <option value="special">🔸 特殊人員</option>
                </select>
                <input type="text" id="searchInput" class="search-input-simple" placeholder="🔍 搜尋姓名...">
            </div>

            <!-- 快速操作選單 -->
            <div class="action-panel">
                <div class="action-dropdown">
                    <button id="actionMenuBtn" class="action-menu-btn">
                        ⚙️ 操作選單
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div id="actionMenuDropdown" class="action-dropdown-content hidden">
                        <div class="dropdown-category-title">📝 新增與編輯</div>
                        <button id="importPersonListBtn" class="action-dropdown-item">📋 批量匯入人員</button>
                        <button id="addTaskBtn" class="action-dropdown-item">📋 新增單次任務</button>

                        <div class="dropdown-divider"></div>
                        <div class="dropdown-category-title">⚙️ 設定管理</div>
                        <button id="manageDepartmentBtn" class="action-dropdown-item">🏢 部門與人員管理</button>
                        <button id="manageTaskTemplateBtn" class="action-dropdown-item">📋 每日任務管理</button>
                        <button id="manageRankLabelBtn" class="action-dropdown-item">🏅 階級名稱管理</button>
                        <button id="manageCompLeaveBtn" class="action-dropdown-item">⏰ 補休管理</button>
                        <button id="manageWorkCategoryBtn" class="action-dropdown-item">⚙️ 工作性質管理</button>

                        <div class="dropdown-divider"></div>
                        <div class="dropdown-category-title">📊 檢視與匯出</div>
                        <button id="previewScheduleBtn" class="action-dropdown-item">📅 預覽排班表</button>
                        <button id="exportDataBtn" class="action-dropdown-item">💾 匯出資料</button>
                        <button id="importDataBtn" class="action-dropdown-item">📥 匯入資料</button>

                        <div class="dropdown-divider"></div>
                        <button id="resetDataBtn" class="action-dropdown-item reset-item">🔄 重置示範資料</button>
                    </div>
                </div>
            </div>
            <input type="file" id="importFileInput" accept=".json" style="display: none;">
        </div>

        <!-- 主要工作區 -->
        <div class="main-workspace">
            <!-- 左側：任務池 -->
            <aside class="task-pool">
                <div class="pool-header collapsible-title" data-target="taskPoolContent">
                    <div>
                        <span class="bracket">[</span>
                        任務池
                        <span class="bracket">]</span>
                        <span class="task-count" id="taskCount">0</span>
                    </div>
                    <span class="collapse-icon">▼</span>
                </div>
                <div id="taskPoolContent" class="collapsible-content">
                    <div class="task-tabs">
                        <button class="task-tab active" data-type="all">全部</button>
                        <button class="task-tab" data-type="daily">日常</button>
                        <button class="task-tab" data-type="important">重要</button>
                        <button class="task-tab" data-type="urgent">臨時</button>
                        <button class="task-tab" data-type="understaffed">⚠️ 未達標</button>
                        <button class="task-tab" data-type="overdue">⏰ 已逾時</button>
                    </div>
                    <div id="taskList" class="task-list"></div>
                </div>
            </aside>

            <!-- 中央：人員網格 -->
            <main class="personnel-grid-area">
                <div class="grid-header-simple">
                    <span class="stat-simple">總計 <strong id="totalCount">0</strong> 人</span>
                    <span class="stat-simple status-free">空閒 <strong id="freeCount">0</strong></span>
                    <span class="stat-simple status-busy">忙碌 <strong id="busyCount">0</strong></span>
                    <span class="stat-simple status-leave">🏖️ 請假 <strong id="leaveCount">0</strong></span>
                    <span class="stat-simple status-mission">🚀 出任務 <strong id="missionCount">0</strong></span>
                    <span class="stat-simple status-lunch">🍱 午休 <strong id="lunchCount">0</strong></span>
                    <span class="stat-simple status-comp-leave">⏰ 補休 <strong id="compLeaveCount">0</strong></span>
                </div>
                <div id="personnelGrid" class="personnel-grid"></div>
            </main>

            <!-- 右側：詳細資訊/統計 -->
            <aside class="detail-panel hidden" id="detailPanel">
                <div class="panel-header-right">
                    <span class="panel-title-right">詳細資訊</span>
                    <button class="close-panel-btn" onclick="closeDetailPanel()">✕</button>
                </div>
                <div id="detailContent" class="detail-content"></div>
            </aside>
        </div>
    </div>

    <!-- 操作記錄與統計 Modal -->
    <div id="statsModal" class="modal hidden">
        <div class="modal-content-large">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">📜 操作記錄與統計</h2>
                <button class="close-btn-cyber" onclick="closeModal('statsModal')">✕</button>
            </div>
            <div class="modal-body-stats">
                <div class="history-section">
                    <h3 class="section-title-small">📝 最近 20 筆操作記錄</h3>
                    <div id="historyList" class="history-list-compact"></div>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯人員 Modal -->
    <div id="personModal" class="modal hidden">
        <div class="modal-content-cyber">
            <div class="modal-header-cyber">
                <h2 id="personModalTitle" class="modal-title-cyber">新增人員</h2>
                <button class="close-btn-cyber" onclick="closeModal('personModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div class="form-group-cyber">
                    <label>姓名</label>
                    <input type="text" id="personName" class="cyber-input" placeholder="請輸入姓名">
                </div>
                <div class="form-group-cyber">
                    <label id="personRankLabel">職位等級</label>
                    <select id="personRankSelect" class="cyber-select">
                        <!-- 選項由 JavaScript 動態生成 -->
                    </select>
                    <input type="hidden" id="personRank" value="3">
                    <input type="hidden" id="personIsSpecial" value="false">
                </div>
                <div class="form-group-cyber">
                    <label>所屬部門</label>
                    <select id="personDepartment" class="cyber-select">
                        <option value="">請選擇部門</option>
                    </select>
                </div>
                <div class="form-group-cyber">
                    <label>聯絡方式</label>
                    <input type="text" id="personContact" class="cyber-input" placeholder="分機或手機">
                </div>
            </div>
            <div class="modal-footer-cyber">
                <button class="btn-secondary-cyber" onclick="closeModal('personModal')">取消</button>
                <button class="btn-primary-cyber" id="savePersonBtn">儲存</button>
            </div>
        </div>
    </div>

    <!-- 新增/編輯任務 Modal -->
    <div id="taskModal" class="modal hidden">
        <div class="modal-content-cyber">
            <div class="modal-header-cyber">
                <h2 id="taskModalTitle" class="modal-title-cyber">新增任務</h2>
                <button class="close-btn-cyber" onclick="closeModal('taskModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div class="form-group-cyber">
                    <label>任務名稱</label>
                    <input type="text" id="taskName" class="cyber-input" placeholder="請輸入任務名稱">
                </div>
                <div class="form-row-cyber">
                    <div class="form-group-cyber">
                        <label>任務日期</label>
                        <input type="date" id="taskDate" class="cyber-input">
                    </div>
                    <div class="form-group-cyber">
                        <label>任務類型</label>
                        <select id="taskType" class="cyber-select">
                            <option value="daily">日常任務</option>
                            <option value="important">重要任務</option>
                            <option value="urgent">臨時任務</option>
                            <option value="leave">🏖️ 請假</option>
                            <option value="mission">🚀 出任務</option>
                            <option value="lunch">🍱 午休</option>
                        </select>
                    </div>
                </div>
                <div class="form-group-cyber">
                    <label>工作性質 <span style="color: var(--gaming-cyan); font-size: 0.85rem;">（用於避免重複性工作）</span></label>
                    <select id="taskWorkCategory" class="cyber-select">
                        <!-- 選項由 JavaScript 動態生成 -->
                    </select>
                </div>
                <div class="form-row-cyber">
                    <div class="form-group-cyber">
                        <label>開始時間</label>
                        <input type="number" id="taskStartHour" min="0" max="23" class="cyber-input" placeholder="0-23">
                    </div>
                    <div class="form-group-cyber">
                        <label>結束時間</label>
                        <input type="number" id="taskEndHour" min="0" max="23" class="cyber-input" placeholder="0-23">
                    </div>
                </div>
                <div class="form-group-cyber">
                    <label>需求人數</label>
                    <input type="number" id="taskRequiredPeople" min="1" max="99" class="cyber-input" placeholder="1-99" value="1">
                    <div style="font-size: 0.85rem; color: var(--gaming-cyan); margin-top: 5px; opacity: 0.8;">
                        💡 人員分配請使用拖拉方式：將任務卡片拖到人員卡片上
                    </div>
                </div>
                <div class="form-group-cyber">
                    <label>任務說明</label>
                    <textarea id="taskDescription" rows="3" class="cyber-textarea" placeholder="選填"></textarea>
                </div>
            </div>
            <div class="modal-footer-cyber">
                <button class="btn-secondary-cyber" onclick="closeModal('taskModal')">取消</button>
                <button class="btn-primary-cyber" id="saveTaskBtn">儲存</button>
            </div>
        </div>
    </div>

    <!-- 排班預覽 Modal -->
    <div id="schedulePreviewModal" class="modal hidden">
        <div class="modal-content-preview">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">📅 排班預覽</h2>
                <button class="close-btn-cyber" onclick="closeModal('schedulePreviewModal')">✕</button>
            </div>
            <div class="modal-body-preview">
                <div class="preview-header">
                    <div class="preview-date-info">
                        <span class="preview-label">日期：</span>
                        <span id="previewDate" class="preview-value"></span>
                    </div>
                    <div class="preview-actions">
                        <button id="exportScheduleTextBtn" class="export-preview-btn">📋 複製文字</button>
                        <button id="exportScheduleImageBtn" class="export-preview-btn">🖼️ 匯出圖片</button>
                    </div>
                </div>
                <div id="schedulePreviewContent" class="schedule-preview-content"></div>
            </div>
        </div>
    </div>

    <!-- 工作性質管理 Modal -->
    <div id="workCategoryModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">⚙️ 工作性質分類管理</h2>
                <button class="close-btn-cyber" onclick="closeModal('workCategoryModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 184, 77, 0.1); border: 1px solid rgba(255, 184, 77, 0.3); border-radius: 8px;">
                    <div style="color: var(--gaming-yellow); font-weight: bold; margin-bottom: 10px;">💡 使用說明</div>
                    <div style="color: var(--gaming-white); font-size: 0.9rem; line-height: 1.6;">
                        • 工作性質用於追蹤人員工作多樣性，避免重複相同性質的工作<br>
                        • 新增分類後，可在建立任務時選擇<br>
                        • 刪除分類不會影響已建立的任務（已有任務會保留原分類名稱）
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 6px;">
                        <div style="color: var(--gaming-cyan); font-weight: bold; margin-bottom: 8px;">📊 重複性判定規則</div>
                        <div style="color: var(--gaming-white); font-size: 0.85rem; line-height: 1.6;">
                            <strong>日常任務</strong>：近 7 天內執行 <strong style="color: var(--gaming-yellow);">7 次以上</strong>同性質工作才會警告<br>
                            <strong>重要任務</strong>：近 7 天內執行 <strong style="color: var(--gaming-yellow);">3 次以上</strong>同性質工作才會警告<br>
                            <strong>其他任務</strong>（臨時/請假/出任務/午休）：不檢查重複性
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    <!-- 新增分類 -->
                    <div>
                        <h3 style="color: var(--gaming-cyan); margin-bottom: 15px; border-bottom: 1px solid rgba(0,255,255,0.3); padding-bottom: 8px;">➕ 新增分類</h3>
                        <div class="form-group-cyber">
                            <label>分類代碼（英文）</label>
                            <input type="text" id="newCategoryKey" class="cyber-input" placeholder="例如: delivery" maxlength="20">
                            <div style="color: var(--gaming-cyan); font-size: 0.8rem; margin-top: 5px;">只能使用英文字母和底線</div>
                        </div>
                        <div class="form-group-cyber">
                            <label>分類名稱（中文）</label>
                            <input type="text" id="newCategoryName" class="cyber-input" placeholder="例如: 外送服務" maxlength="20">
                        </div>
                        <button onclick="addWorkCategory()" class="cyber-btn-primary" style="width: 100%; margin-top: 10px;">
                            ➕ 新增分類
                        </button>
                    </div>

                    <!-- 已有分類列表 -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(0,255,255,0.3); padding-bottom: 8px;">
                            <h3 style="color: var(--gaming-cyan); margin: 0;">📋 現有分類</h3>
                            <button onclick="clearAllWorkCategories()" style="padding: 5px 10px; background: rgba(255, 0, 128, 0.2); border: 1px solid var(--status-busy); border-radius: 5px; color: var(--status-busy); cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: all 0.3s;">
                                🗑️ 清空全部
                            </button>
                        </div>
                        <div id="categoryListContainer" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- 出任務類型管理 -->
                <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid rgba(78, 205, 196, 0.3);">
                    <h2 style="color: #4ECDC4; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span>🚀 出任務類型管理</span>
                    </h2>

                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 8px;">
                        <div style="color: #4ECDC4; font-weight: bold; margin-bottom: 10px;">💡 使用說明</div>
                        <div style="color: var(--gaming-white); font-size: 0.9rem; line-height: 1.6;">
                            • 出任務類型用於區分不同的外勤任務性質<br>
                            • 新增類型後，設定出任務時可在下拉選單中選擇<br>
                            • 便於統計各類型任務的執行次數和人員配置
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <!-- 新增出任務類型 -->
                        <div>
                            <h3 style="color: #4ECDC4; margin-bottom: 15px; border-bottom: 1px solid rgba(78, 205, 196, 0.3); padding-bottom: 8px;">➕ 新增類型</h3>
                            <div class="form-group-cyber">
                                <label>類型代碼（英文）</label>
                                <input type="text" id="newMissionKey" class="cyber-input" placeholder="例如: transport" maxlength="20">
                                <div style="color: #4ECDC4; font-size: 0.8rem; margin-top: 5px;">只能使用英文字母和底線</div>
                            </div>
                            <div class="form-group-cyber">
                                <label>類型名稱（中文）</label>
                                <input type="text" id="newMissionName" class="cyber-input" placeholder="例如: 運輸任務" maxlength="20">
                            </div>
                            <button onclick="addMissionCategory()" class="cyber-btn-primary" style="width: 100%; margin-top: 10px; background: #4ECDC4; border-color: #4ECDC4;">
                                ➕ 新增類型
                            </button>
                        </div>

                        <!-- 已有出任務類型列表 -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(78, 205, 196, 0.3); padding-bottom: 8px;">
                                <h3 style="color: #4ECDC4; margin: 0;">📋 現有類型</h3>
                                <button onclick="clearAllMissionCategories()" style="padding: 5px 10px; background: rgba(255, 0, 128, 0.2); border: 1px solid var(--status-busy); border-radius: 5px; color: var(--status-busy); cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: all 0.3s;">
                                    🗑️ 清空全部
                                </button>
                            </div>
                            <div id="missionCategoryListContainer" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 部門管理 Modal -->
    <div id="departmentModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-extra-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">🏢 部門與人員管理</h2>
                <button class="close-btn-cyber" onclick="closeModal('departmentModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div style="display: grid; grid-template-columns: 280px 1fr; gap: 20px; min-height: 500px;">
                    <!-- 左側：部門列表 -->
                    <div style="border-right: 1px solid rgba(0,255,255,0.2); padding-right: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--gaming-cyan); margin: 0; font-size: 1rem;">📋 部門列表</h3>
                            <button onclick="showAddDepartmentForm()" class="cyber-btn-small" style="padding: 5px 10px; font-size: 0.85rem;">➕ 新增</button>
                        </div>

                        <!-- 無部門人員選項 -->
                        <div id="noDeptOption" class="dept-list-item" onclick="selectDepartment(null)" style="margin-bottom: 10px; padding: 10px; background: rgba(255,107,107,0.1); border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #ff6b6b; font-weight: bold;">⚠️ 無部門</span>
                                <span id="noDeptCount" style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">0</span>
                            </div>
                        </div>

                        <div id="departmentListContainer" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <!-- 右側：部門詳情與人員管理 -->
                    <div id="deptDetailPanel">
                        <div id="deptDetailContent" style="color: var(--gaming-white); text-align: center; padding: 50px 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">👈</div>
                            <div style="color: var(--gaming-cyan);">請從左側選擇一個部門</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯部門 Modal -->
    <div id="deptEditModal" class="modal hidden">
        <div class="modal-content-cyber">
            <div class="modal-header-cyber">
                <h2 id="deptEditModalTitle" class="modal-title-cyber">➕ 新增部門</h2>
                <button class="close-btn-cyber" onclick="closeModal('deptEditModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div class="form-group-cyber">
                    <label>部門名稱</label>
                    <input type="text" id="deptName" class="cyber-input" placeholder="例如: 業務部" maxlength="20">
                </div>
                <div class="form-group-cyber">
                    <label>部門描述</label>
                    <input type="text" id="deptDescription" class="cyber-input" placeholder="例如: 負責業務開發與客戶服務" maxlength="50">
                </div>
                <div class="form-group-cyber">
                    <label>部門顏色</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="deptColor" class="cyber-input" value="#4ECDC4" style="width: 60px; height: 40px; padding: 2px; cursor: pointer;">
                        <span id="deptColorPreview" style="flex: 1; padding: 8px; background: #4ECDC4; border-radius: 5px; text-align: center; color: white; font-weight: bold;">預覽顏色</span>
                    </div>
                </div>
                <input type="hidden" id="editingDeptId">
            </div>
            <div class="modal-footer-cyber">
                <button class="btn-secondary-cyber" onclick="closeModal('deptEditModal')">取消</button>
                <button class="btn-primary-cyber" onclick="saveDepartment()">💾 儲存</button>
            </div>
        </div>
    </div>

    <!-- 每日任務管理 Modal -->
    <div id="taskTemplateModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-extra-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">📋 每日任務管理</h2>
                <button class="close-btn-cyber" onclick="closeModal('taskTemplateModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px;">
                    <div style="color: var(--neon-green); font-weight: bold; margin-bottom: 10px;">💡 使用說明</div>
                    <div style="color: var(--gaming-white); font-size: 0.9rem; line-height: 1.6;">
                        • 在這裡設定的任務會<strong style="color: var(--gaming-yellow);">每天自動出現</strong>在任務池中<br>
                        • 分為「日常」、「重要」、「臨時」三種類型<br>
                        • 每日任務不需要指定日期，系統會自動套用到每一天<br>
                        • 若需要新增只出現一次的任務，請使用「新增單次任務」
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px; min-height: 450px;">
                    <!-- 左側：任務類型選擇 -->
                    <div style="border-right: 1px solid rgba(0,255,255,0.2); padding-right: 20px;">
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: var(--gaming-cyan); margin: 0 0 15px 0; font-size: 1rem;">📁 任務類型</h3>
                        </div>

                        <div id="taskTypeDaily" class="task-type-item selected" onclick="selectTaskType('daily')" style="padding: 12px; background: rgba(0, 255, 136, 0.2); border: 1px solid var(--status-free); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--status-free); font-weight: bold;">📅 日常任務</span>
                                <span id="dailyTaskCount" style="background: var(--status-free); color: black; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">0</span>
                            </div>
                            <div style="color: var(--gaming-white); font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">每天例行的工作</div>
                        </div>

                        <div id="taskTypeImportant" class="task-type-item" onclick="selectTaskType('important')" style="padding: 12px; background: rgba(255, 0, 128, 0.1); border: 1px solid rgba(255, 0, 128, 0.3); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--status-busy); font-weight: bold;">⭐ 重要任務</span>
                                <span id="importantTaskCount" style="background: var(--status-busy); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">0</span>
                            </div>
                            <div style="color: var(--gaming-white); font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">重要的每日工作</div>
                        </div>

                        <div id="taskTypeUrgent" class="task-type-item" onclick="selectTaskType('urgent')" style="padding: 12px; background: rgba(255, 107, 0, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--status-partial); font-weight: bold;">⚡ 臨時任務</span>
                                <span id="urgentTaskCount" style="background: var(--status-partial); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">0</span>
                            </div>
                            <div style="color: var(--gaming-white); font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">每日固定的臨時性工作</div>
                        </div>
                    </div>

                    <!-- 右側：任務列表與管理 -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 id="taskListTitle" style="color: var(--gaming-white); margin: 0;">📅 日常任務</h3>
                            <button onclick="showAddTaskTemplate()" class="cyber-btn-primary" style="padding: 8px 15px;">➕ 新增任務</button>
                        </div>
                        <div id="taskTemplateListContainer" style="max-height: 400px; overflow-y: auto;">
                            <!-- 任務列表會動態插入這裡 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯任務模板 Modal -->
    <div id="taskTemplateEditModal" class="modal hidden">
        <div class="modal-content-cyber">
            <div class="modal-header-cyber">
                <h2 id="taskTemplateEditTitle" class="modal-title-cyber">➕ 新增每日任務</h2>
                <button class="close-btn-cyber" onclick="closeModal('taskTemplateEditModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div class="form-group-cyber">
                    <label>任務名稱</label>
                    <input type="text" id="templateTaskName" class="cyber-input" placeholder="請輸入任務名稱">
                </div>
                <div class="form-row-cyber">
                    <div class="form-group-cyber">
                        <label>開始時間</label>
                        <input type="number" id="templateStartHour" min="0" max="23" class="cyber-input" placeholder="0-23">
                    </div>
                    <div class="form-group-cyber">
                        <label>結束時間</label>
                        <input type="number" id="templateEndHour" min="1" max="24" class="cyber-input" placeholder="1-24">
                    </div>
                </div>
                <div class="form-group-cyber">
                    <label>需求人數</label>
                    <input type="number" id="templateRequiredPeople" min="1" max="99" class="cyber-input" value="1">
                </div>
                <div class="form-group-cyber">
                    <label>任務說明</label>
                    <textarea id="templateDescription" rows="2" class="cyber-textarea" placeholder="選填"></textarea>
                </div>
                <input type="hidden" id="editingTemplateId">
                <input type="hidden" id="editingTemplateType">
            </div>
            <div class="modal-footer-cyber">
                <button class="btn-secondary-cyber" onclick="closeModal('taskTemplateEditModal')">取消</button>
                <button class="btn-primary-cyber" onclick="saveTaskTemplate()">💾 儲存</button>
            </div>
        </div>
    </div>

    <!-- 階級名稱管理 Modal -->
    <div id="rankLabelModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">🏅 階級名稱管理</h2>
                <button class="close-btn-cyber" onclick="closeModal('rankLabelModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 184, 77, 0.1); border: 1px solid rgba(255, 184, 77, 0.3); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="color: var(--gaming-yellow); font-weight: bold; margin-bottom: 5px;">階級範圍設定</div>
                            <div style="color: var(--gaming-white); font-size: 0.9rem;" id="currentMaxRankDisplay">目前最高階級：LV10</div>
                        </div>
                        <button onclick="setMaxRank()" class="btn-cyber" style="padding: 8px 16px;">修改範圍</button>
                    </div>
                    <div style="color: var(--gaming-white); font-size: 0.85rem; opacity: 0.8; line-height: 1.6;">
                        • 為每個階級設定自訂名稱<br>
                        • 階級名稱會顯示在人員卡片和各處資訊中<br>
                        • 修改後會立即更新所有顯示位置
                    </div>
                </div>

                <div id="rankLabelListContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- 設定狀態時間範圍 Modal -->
    <div id="statusTimeRangeModal" class="modal hidden">
        <div class="modal-content-cyber">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber" id="statusTimeRangeTitle">設定請假時間</h2>
                <button class="close-btn-cyber" onclick="closeModal('statusTimeRangeModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <!-- 時間類型選擇 -->
                <div class="form-group-cyber" style="margin-bottom: 20px;">
                    <label style="margin-bottom: 10px; display: block; font-weight: bold; color: #FFD700;">請選擇類型</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" id="selectHourlyMode" class="status-type-btn active" onclick="switchStatusTimeMode('hourly')" style="padding: 12px; background: #FFD700; color: #000000; border: 2px solid #FFD700; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 1rem;">
                            ⏰ 按小時
                        </button>
                        <button type="button" id="selectDailyMode" class="status-type-btn" onclick="switchStatusTimeMode('daily')" style="padding: 12px; background: rgba(255,255,255,0.1); color: #FFFFFF; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 1rem;">
                            📅 按天數
                        </button>
                    </div>
                </div>

                <!-- 按小時模式 -->
                <div id="hourlyModeFields">
                    <div class="form-group-cyber">
                        <label>日期</label>
                        <input type="date" id="statusSingleDate" class="cyber-input">
                    </div>
                    <div class="form-row-cyber">
                        <div class="form-group-cyber">
                            <label>開始時間</label>
                            <input type="number" id="statusStartHour" class="cyber-input" min="0" max="23" value="8" placeholder="小時 (0-23)">
                        </div>
                        <div class="form-group-cyber">
                            <label>結束時間</label>
                            <input type="number" id="statusEndHour" class="cyber-input" min="1" max="24" value="17" placeholder="小時 (1-24)">
                        </div>
                    </div>
                </div>

                <!-- 按天數模式 -->
                <div id="dailyModeFields" style="display: none;">
                    <div class="form-group-cyber">
                        <label>開始日期</label>
                        <input type="date" id="statusStartDate" class="cyber-input">
                    </div>
                    <div class="form-group-cyber">
                        <label>結束日期</label>
                        <input type="date" id="statusEndDate" class="cyber-input">
                    </div>
                    <div style="padding: 10px; background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 5px; margin-top: 10px;">
                        <small style="color: var(--gaming-cyan);">💡 按天數會自動設定為全天（0:00-24:00）</small>
                    </div>
                </div>

                <!-- 出任務類型選擇（只在出任務時顯示） -->
                <div class="form-group-cyber" id="missionCategoryField" style="margin-top: 15px; display: none;">
                    <label>🚀 出任務類型</label>
                    <select id="missionCategorySelect" class="cyber-input">
                        <!-- 選項將由 JavaScript 動態生成 -->
                    </select>
                    <div style="padding: 8px; background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 5px; margin-top: 8px;">
                        <small style="color: var(--gaming-cyan);">💡 選擇此次出任務的類型，便於統計管理</small>
                    </div>
                </div>

                <!-- 備註 -->
                <div class="form-group-cyber" style="margin-top: 15px;">
                    <label>備註</label>
                    <textarea id="statusDescription" class="cyber-input" rows="2" placeholder="選填：例如請假原因、出任務地點等"></textarea>
                </div>
            </div>
            <div class="modal-footer-cyber">
                <button class="btn-cyber-secondary" onclick="closeModal('statusTimeRangeModal')">取消</button>
                <button class="btn-cyber" id="confirmStatusTimeRange">確認</button>
            </div>
        </div>
    </div>

    <!-- 批量匯入人員 Modal -->
    <div id="importPersonListModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">批量匯入人員</h2>
                <button class="close-btn-cyber" onclick="closeModal('importPersonListModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div class="import-instructions">
                    <p style="color: var(--gaming-cyan); margin-bottom: 10px;">
                        💡 填寫人員資料後點擊「開始匯入」，可以一次新增多位人員
                    </p>
                </div>
                <div class="import-table-container">
                    <table class="import-table">
                        <thead>
                            <tr>
                                <th style="width: 25%;">姓名 *</th>
                                <th style="width: 25%;">職位等級 *</th>
                                <th style="width: 20%;">部門</th>
                                <th style="width: 20%;">聯絡方式</th>
                                <th style="width: 10%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="importTableBody">
                            <!-- 動態生成的行會插入這裡 -->
                        </tbody>
                    </table>
                </div>
                <button class="btn-add-row" id="addPersonRowBtn">➕ 新增一行</button>
                <div class="form-group-cyber" style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="clearExistingPersonnel" class="cyber-checkbox">
                        <span>清除現有人員（勾選後會刪除所有現有人員，只保留匯入的）</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer-cyber">
                <button class="btn-secondary-cyber" onclick="closeModal('importPersonListModal')">取消</button>
                <button class="btn-primary-cyber" id="confirmImportPersonList">開始匯入</button>
            </div>
        </div>
    </div>

    <!-- 補休管理 Modal -->
    <div id="compensatoryLeaveModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-extra-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">⏰ 補休管理</h2>
                <button class="close-btn-cyber" onclick="closeModal('compensatoryLeaveModal')">✕</button>
            </div>
            <div class="modal-body-cyber">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px;">
                    <div style="color: var(--gaming-cyan); font-weight: bold; margin-bottom: 10px;">💡 補休規則說明</div>
                    <div style="color: var(--gaming-white); font-size: 0.9rem; line-height: 1.6;">
                        • <strong>午休時間工作</strong>：中午12點到下午1點工作 → 下午1點開始補休<br>
                        • <strong>晚間加班</strong>：晚上10點後工作 → 工作結束後開始補休<br>
                        • <strong>自動跳過休息時間</strong>：補休會自動跳過午休（12:00-13:00）和睡覺時間（00:00-06:00）<br>
                        • <strong>智能排程</strong>：如果任務結束時間在休息時段內，補休會自動延後至休息時段結束後<br>
                        • <strong>時段保護</strong>：補休時段內無法被分配其他任務<br>
                        • 系統會自動掃描任務記錄並計算補休時數
                    </div>
                </div>

                <div class="comp-leave-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">總計記錄</div>
                        <div class="stat-value" id="totalCompLeaves">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">今日補休</div>
                        <div class="stat-value" id="pendingCompLeaves">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">已排程</div>
                        <div class="stat-value" id="approvedCompLeaves">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">總補休時數</div>
                        <div class="stat-value" id="totalCompHours">0h</div>
                    </div>
                </div>

                <div id="compensatoryLeaveList" class="compensatory-leave-list">
                    <!-- 補休記錄會動態插入這裡 -->
                </div>
            </div>
            <div class="modal-footer-cyber">
                <button class="btn-secondary-cyber" onclick="closeModal('compensatoryLeaveModal')">關閉</button>
                <button class="btn-primary-cyber" onclick="calculateCompensatoryLeaves(); renderCompensatoryLeaveList();">🔄 重新計算</button>
            </div>
        </div>
    </div>

    <!-- 任務詳細資訊 Modal (手機版專用) -->
    <div id="taskDetailModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">📋 任務詳細資訊</h2>
                <button class="close-btn-cyber" onclick="closeModal('taskDetailModal')">✕</button>
            </div>
            <div class="modal-body-cyber" id="taskDetailModalContent">
                <!-- 任務詳細資訊會動態插入這裡 -->
            </div>
        </div>
    </div>

    <!-- 人員詳細資訊 Modal (手機版專用) -->
    <div id="personDetailModal" class="modal hidden">
        <div class="modal-content-cyber modal-content-wide">
            <div class="modal-header-cyber">
                <h2 class="modal-title-cyber">👤 人員詳細資訊</h2>
                <button class="close-btn-cyber" onclick="closeModal('personDetailModal')">✕</button>
            </div>
            <div class="modal-body-cyber" id="personDetailModalContent">
                <!-- 人員詳細資訊會動態插入這裡 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="config.js"></script>
    <script src="script.js"></script>
</body>
</html>
