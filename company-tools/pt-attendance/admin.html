<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT æ‰“å¡ç³»çµ± - ç®¡ç†å¾Œå°</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <h1>ğŸ“Š PT æ‰“å¡ç³»çµ±</h1>
            <div class="nav-links">
                <a href="index.html">å“¡å·¥ç®¡ç†</a>
                <a href="admin.html" class="active">ç®¡ç†å¾Œå°</a>
            </div>
        </nav>

        <div class="content">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalEmployees">0</div>
                        <div class="stat-label">ç¸½å“¡å·¥æ•¸</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-info">
                        <div class="stat-value" id="todayCheckIn">0</div>
                        <div class="stat-label">ä»Šæ—¥å·²ä¸Šç­</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘‹</div>
                    <div class="stat-info">
                        <div class="stat-value" id="todayCheckOut">0</div>
                        <div class="stat-label">ä»Šæ—¥å·²ä¸‹ç­</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âš ï¸</div>
                    <div class="stat-info">
                        <div class="stat-value" id="notCheckedIn">0</div>
                        <div class="stat-label">ä»Šæ—¥æœªæ‰“å¡</div>
                    </div>
                </div>
            </div>

            <!-- ç¯©é¸å™¨ -->
            <div class="section">
                <h2>æ‰“å¡è¨˜éŒ„æŸ¥è©¢</h2>
                <div class="filter-bar">
                    <div class="form-group">
                        <label for="filterDate">æ—¥æœŸ</label>
                        <input type="date" id="filterDate">
                    </div>
                    <div class="form-group">
                        <label for="filterEmployee">å“¡å·¥</label>
                        <select id="filterEmployee">
                            <option value="">å…¨éƒ¨å“¡å·¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterType">é¡å‹</label>
                        <select id="filterType">
                            <option value="">å…¨éƒ¨</option>
                            <option value="check_in">ä¸Šç­</option>
                            <option value="check_out">ä¸‹ç­</option>
                        </select>
                    </div>
                    <button id="filterBtn" class="btn btn-primary">ğŸ” æŸ¥è©¢</button>
                    <button id="resetFilterBtn" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
                </div>
            </div>

            <!-- æ‰“å¡è¨˜éŒ„è¡¨æ ¼ -->
            <div class="section">
                <div class="section-header">
                    <h2>æ‰“å¡è¨˜éŒ„</h2>
                    <div class="action-buttons">
                        <button id="exportExcel" class="btn btn-success">ğŸ“¥ åŒ¯å‡º Excel</button>
                        <button id="exportCSV" class="btn btn-success">ğŸ“¥ åŒ¯å‡º CSV</button>
                        <button id="refreshData" class="btn btn-secondary">ğŸ”„ é‡æ–°æ•´ç†</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="attendanceTable" class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ™‚é–“</th>
                                <th>å“¡å·¥å§“å</th>
                                <th>å“¡å·¥ç·¨è™Ÿ</th>
                                <th>éƒ¨é–€</th>
                                <th>é¡å‹</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr>
                                <td colspan="7" class="loading">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å“¡å·¥å‡ºå‹¤çµ±è¨ˆ -->
            <div class="section">
                <h2>å“¡å·¥å‡ºå‹¤çµ±è¨ˆï¼ˆæœ¬æœˆï¼‰</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å“¡å·¥å§“å</th>
                                <th>å“¡å·¥ç·¨è™Ÿ</th>
                                <th>éƒ¨é–€</th>
                                <th>å‡ºå‹¤å¤©æ•¸</th>
                                <th>é²åˆ°æ¬¡æ•¸</th>
                                <th>æ—©é€€æ¬¡æ•¸</th>
                                <th>æœªæ‰“å¡æ¬¡æ•¸</th>
                            </tr>
                        </thead>
                        <tbody id="employeeStatsBody">
                            <tr>
                                <td colspan="7" class="loading">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        let currentRecords = [];

        document.addEventListener('DOMContentLoaded', function() {
            initGoogleSheets();
            loadDashboardData();

            // è¨­å®šä»Šå¤©ç‚ºé è¨­æ—¥æœŸ
            document.getElementById('filterDate').valueAsDate = new Date();

            // æŸ¥è©¢æŒ‰éˆ•
            document.getElementById('filterBtn').addEventListener('click', function() {
                loadAttendanceRecords();
            });

            // é‡ç½®æŒ‰éˆ•
            document.getElementById('resetFilterBtn').addEventListener('click', function() {
                document.getElementById('filterDate').valueAsDate = new Date();
                document.getElementById('filterEmployee').value = '';
                document.getElementById('filterType').value = '';
                loadAttendanceRecords();
            });

            // åŒ¯å‡ºæŒ‰éˆ•
            document.getElementById('exportExcel').addEventListener('click', function() {
                exportToExcel();
            });

            document.getElementById('exportCSV').addEventListener('click', function() {
                exportToCSV();
            });

            // é‡æ–°æ•´ç†
            document.getElementById('refreshData').addEventListener('click', function() {
                loadDashboardData();
            });
        });

        async function loadDashboardData() {
            await Promise.all([
                loadStats(),
                loadEmployeeFilter(),
                loadAttendanceRecords(),
                loadEmployeeStats()
            ]);
        }

        async function loadStats() {
            try {
                const employees = await getAllEmployees();
                const today = new Date().toLocaleDateString('zh-TW');
                const todayRecords = await getAttendanceByDate(today);

                document.getElementById('totalEmployees').textContent = employees.length;

                const checkInCount = todayRecords.filter(r => r.type === 'check_in').length;
                const checkOutCount = todayRecords.filter(r => r.type === 'check_out').length;
                const uniqueCheckIn = new Set(todayRecords.filter(r => r.type === 'check_in').map(r => r.employeeId)).size;

                document.getElementById('todayCheckIn').textContent = uniqueCheckIn;
                document.getElementById('todayCheckOut').textContent = checkOutCount;
                document.getElementById('notCheckedIn').textContent = employees.length - uniqueCheckIn;
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š', error);
            }
        }

        async function loadEmployeeFilter() {
            try {
                const employees = await getAllEmployees();
                const select = document.getElementById('filterEmployee');
                select.innerHTML = '<option value="">å…¨éƒ¨å“¡å·¥</option>';
                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (${emp.id})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—ï¼š', error);
            }
        }

        async function loadAttendanceRecords() {
            try {
                const date = document.getElementById('filterDate').value;
                const employeeId = document.getElementById('filterEmployee').value;
                const type = document.getElementById('filterType').value;

                let records = await getAllAttendanceRecords();

                // ç¯©é¸
                if (date) {
                    const filterDate = new Date(date).toLocaleDateString('zh-TW');
                    records = records.filter(r => r.date === filterDate);
                }
                if (employeeId) {
                    records = records.filter(r => r.employeeId === employeeId);
                }
                if (type) {
                    records = records.filter(r => r.type === type);
                }

                // æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                currentRecords = records;
                renderAttendanceTable(records);
            } catch (error) {
                console.error('è¼‰å…¥æ‰“å¡è¨˜éŒ„å¤±æ•—ï¼š', error);
                document.getElementById('attendanceTableBody').innerHTML =
                    '<tr><td colspan="7" class="error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</td></tr>';
            }
        }

        function renderAttendanceTable(records) {
            const tbody = document.getElementById('attendanceTableBody');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">æŸ¥ç„¡è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(record => {
                const typeText = record.type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­';
                const typeClass = record.type === 'check_in' ? 'badge-success' : 'badge-danger';
                const icon = record.type === 'check_in' ? 'âœ…' : 'ğŸ‘‹';

                return `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.time}</td>
                        <td>${record.employeeName}</td>
                        <td>${record.employeeId}</td>
                        <td>${record.department || '-'}</td>
                        <td><span class="badge ${typeClass}">${icon} ${typeText}</span></td>
                        <td><span class="badge badge-info">å·²å®Œæˆ</span></td>
                    </tr>
                `;
            }).join('');
        }

        async function loadEmployeeStats() {
            try {
                const employees = await getAllEmployees();
                const records = await getAllAttendanceRecords();

                // è¨ˆç®—æœ¬æœˆçµ±è¨ˆ
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthRecords = records.filter(r => new Date(r.timestamp) >= firstDay);

                const stats = employees.map(emp => {
                    const empRecords = monthRecords.filter(r => r.employeeId === emp.id);
                    const checkInDays = new Set(empRecords.filter(r => r.type === 'check_in').map(r => r.date));

                    return {
                        name: emp.name,
                        id: emp.id,
                        department: emp.department || '-',
                        attendanceDays: checkInDays.size,
                        lateCount: 0, // éœ€è¦å®šç¾©é²åˆ°è¦å‰‡
                        earlyLeaveCount: 0, // éœ€è¦å®šç¾©æ—©é€€è¦å‰‡
                        missingCount: 0 // éœ€è¦å®šç¾©æœªæ‰“å¡è¦å‰‡
                    };
                });

                renderEmployeeStats(stats);
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥çµ±è¨ˆå¤±æ•—ï¼š', error);
            }
        }

        function renderEmployeeStats(stats) {
            const tbody = document.getElementById('employeeStatsBody');
            if (stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">æŸ¥ç„¡è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = stats.map(stat => `
                <tr>
                    <td>${stat.name}</td>
                    <td>${stat.id}</td>
                    <td>${stat.department}</td>
                    <td>${stat.attendanceDays}</td>
                    <td>${stat.lateCount}</td>
                    <td>${stat.earlyLeaveCount}</td>
                    <td>${stat.missingCount}</td>
                </tr>
            `).join('');
        }

        function exportToExcel() {
            if (currentRecords.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            const data = currentRecords.map(record => ({
                'æ—¥æœŸ': record.date,
                'æ™‚é–“': record.time,
                'å“¡å·¥å§“å': record.employeeName,
                'å“¡å·¥ç·¨è™Ÿ': record.employeeId,
                'éƒ¨é–€': record.department || '-',
                'é¡å‹': record.type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ‰“å¡è¨˜éŒ„');

            const filename = `æ‰“å¡è¨˜éŒ„_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function exportToCSV() {
            if (currentRecords.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            const headers = ['æ—¥æœŸ', 'æ™‚é–“', 'å“¡å·¥å§“å', 'å“¡å·¥ç·¨è™Ÿ', 'éƒ¨é–€', 'é¡å‹'];
            const rows = currentRecords.map(record => [
                record.date,
                record.time,
                record.employeeName,
                record.employeeId,
                record.department || '-',
                record.type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­'
            ]);

            let csv = '\uFEFF'; // BOM for UTF-8
            csv += headers.join(',') + '\n';
            csv += rows.map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `æ‰“å¡è¨˜éŒ„_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '')}.csv`);
            link.click();
        }
    </script>
</body>
</html>
