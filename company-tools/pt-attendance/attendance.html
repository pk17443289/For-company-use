<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT æ‰“å¡ç³»çµ± - æ‰“å¡é é¢</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="attendance-header">
            <h1>â° PT æ‰“å¡ç³»çµ±</h1>
            <div id="currentTime" class="current-time"></div>
        </div>

        <div class="content attendance-content">
            <!-- å“¡å·¥è³‡è¨Šå€ -->
            <div id="employeeInfo" class="employee-info" style="display: none;">
                <div class="info-card">
                    <h2 id="empName"></h2>
                    <p><strong>å“¡å·¥ç·¨è™Ÿï¼š</strong><span id="empId"></span></p>
                    <p><strong>éƒ¨é–€ï¼š</strong><span id="empDept"></span></p>
                    <div id="todayStatus" class="today-status"></div>
                </div>
            </div>

            <!-- QR Code æƒæå€ -->
            <div id="scanSection" class="section">
                <h2>è«‹æƒææ‚¨çš„ QR Code</h2>
                <div id="reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
                <div class="scan-controls">
                    <button id="startScan" class="btn btn-primary">ğŸ“· é–‹å§‹æƒæ</button>
                    <button id="stopScan" class="btn btn-secondary" style="display: none;">â¹ï¸ åœæ­¢æƒæ</button>
                </div>
                <p class="scan-instruction">æˆ–æ‰‹å‹•è¼¸å…¥å“¡å·¥ç·¨è™Ÿ</p>
                <form id="manualInputForm" class="manual-input">
                    <input type="text" id="manualEmployeeId" placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ" required>
                    <button type="submit" class="btn btn-secondary">ç¢ºèª</button>
                </form>
            </div>

            <!-- æ‰“å¡æŒ‰éˆ•å€ -->
            <div id="attendanceButtons" class="section" style="display: none;">
                <div class="attendance-actions">
                    <button id="checkIn" class="btn btn-success btn-large">
                        âœ… ä¸Šç­æ‰“å¡
                    </button>
                    <button id="checkOut" class="btn btn-danger btn-large">
                        ğŸ‘‹ ä¸‹ç­æ‰“å¡
                    </button>
                </div>
                <button id="resetScan" class="btn btn-secondary">ğŸ”„ é‡æ–°æƒæ</button>
            </div>

            <!-- æ‰“å¡çµæœé¡¯ç¤º -->
            <div id="attendanceResult" class="attendance-result" style="display: none;"></div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        let html5QrCode;
        let currentEmployee = null;

        document.addEventListener('DOMContentLoaded', function() {
            initGoogleSheets();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // é–‹å§‹æƒæ
            document.getElementById('startScan').addEventListener('click', function() {
                startQRScanner();
            });

            // åœæ­¢æƒæ
            document.getElementById('stopScan').addEventListener('click', function() {
                stopQRScanner();
            });

            // æ‰‹å‹•è¼¸å…¥
            document.getElementById('manualInputForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const employeeId = document.getElementById('manualEmployeeId').value;
                await loadEmployeeData(employeeId);
            });

            // ä¸Šç­æ‰“å¡
            document.getElementById('checkIn').addEventListener('click', async function() {
                await recordAttendance('check_in');
            });

            // ä¸‹ç­æ‰“å¡
            document.getElementById('checkOut').addEventListener('click', async function() {
                await recordAttendance('check_out');
            });

            // é‡æ–°æƒæ
            document.getElementById('resetScan').addEventListener('click', function() {
                resetPage();
            });
        });

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function startQRScanner() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                onScanSuccess,
                onScanError
            ).then(() => {
                document.getElementById('startScan').style.display = 'none';
                document.getElementById('stopScan').style.display = 'inline-block';
            }).catch(err => {
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š' + err);
            });
        }

        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('startScan').style.display = 'inline-block';
                    document.getElementById('stopScan').style.display = 'none';
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            stopQRScanner();
            loadEmployeeData(decodedText);
        }

        function onScanError(errorMessage) {
            // å¿½ç•¥æƒæéŒ¯èª¤
        }

        async function loadEmployeeData(employeeId) {
            try {
                const employee = await getEmployeeById(employeeId);
                if (employee) {
                    currentEmployee = employee;
                    document.getElementById('empName').textContent = employee.name;
                    document.getElementById('empId').textContent = employee.id;
                    document.getElementById('empDept').textContent = employee.department || 'æœªè¨­å®š';

                    // è¼‰å…¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹
                    await loadTodayStatus(employeeId);

                    document.getElementById('scanSection').style.display = 'none';
                    document.getElementById('employeeInfo').style.display = 'block';
                    document.getElementById('attendanceButtons').style.display = 'block';
                } else {
                    alert('æ‰¾ä¸åˆ°æ­¤å“¡å·¥è³‡æ–™');
                }
            } catch (error) {
                alert('è¼‰å…¥å“¡å·¥è³‡æ–™å¤±æ•—ï¼š' + error.message);
            }
        }

        async function loadTodayStatus(employeeId) {
            const today = new Date().toLocaleDateString('zh-TW');
            const records = await getTodayAttendance(employeeId);

            const statusDiv = document.getElementById('todayStatus');
            if (records.length > 0) {
                let html = '<h3>ä»Šæ—¥æ‰“å¡è¨˜éŒ„</h3><div class="status-list">';
                records.forEach(record => {
                    const type = record.type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­';
                    const icon = record.type === 'check_in' ? 'âœ…' : 'ğŸ‘‹';
                    html += `<div class="status-item">${icon} ${type}ï¼š${record.time}</div>`;
                });
                html += '</div>';
                statusDiv.innerHTML = html;
            } else {
                statusDiv.innerHTML = '<p class="no-record">ä»Šæ—¥å°šæœªæ‰“å¡</p>';
            }
        }

        async function recordAttendance(type) {
            if (!currentEmployee) return;

            try {
                const now = new Date();
                const record = {
                    employeeId: currentEmployee.id,
                    employeeName: currentEmployee.name,
                    department: currentEmployee.department,
                    type: type,
                    date: now.toLocaleDateString('zh-TW'),
                    time: now.toLocaleTimeString('zh-TW', { hour12: false }),
                    timestamp: now.toISOString()
                };

                await saveAttendanceRecord(record);

                // é¡¯ç¤ºçµæœ
                const typeText = type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­';
                const icon = type === 'check_in' ? 'âœ…' : 'ğŸ‘‹';
                showResult(`${icon} ${typeText}æ‰“å¡æˆåŠŸï¼\næ™‚é–“ï¼š${record.time}`, 'success');

                // ç™¼é€é€šçŸ¥
                await sendNotification(record);

                // 3ç§’å¾Œé‡ç½®é é¢
                setTimeout(resetPage, 3000);
            } catch (error) {
                showResult('âŒ æ‰“å¡å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('attendanceResult');
            resultDiv.className = 'attendance-result ' + type;
            resultDiv.innerHTML = message.replace(/\n/g, '<br>');
            resultDiv.style.display = 'block';
            document.getElementById('attendanceButtons').style.display = 'none';
        }

        function resetPage() {
            currentEmployee = null;
            document.getElementById('employeeInfo').style.display = 'none';
            document.getElementById('attendanceButtons').style.display = 'none';
            document.getElementById('attendanceResult').style.display = 'none';
            document.getElementById('scanSection').style.display = 'block';
            document.getElementById('manualEmployeeId').value = '';
        }
    </script>
</body>
</html>
