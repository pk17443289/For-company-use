<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工異常行為與績效回報表</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; line-height: 1.6; margin: 20px; background-color: #f0f4f7; }
        .report-form { max-width: 700px; margin: auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #004a99; border-bottom: 3px solid #004a99; padding-bottom: 10px; text-align: center; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input[type="text"], input[type="date"], input[type="time"], select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        /* 讓日期和時間輸入框點擊任何地方都能開啟選擇器 */
        input[type="date"], input[type="time"] {
            cursor: pointer;
            position: relative;
        }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }
        textarea { resize: vertical; min-height: 100px; }
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 25px;
            width: 100%;
            font-size: 18px;
            transition: background-color 0.3s;
        }
        .submit-btn:hover { background-color: #45a049; }
        .section-header { margin-top: 25px; padding: 5px 0; border-bottom: 2px solid #ddd; color: #cc0000; }
        .required::after { content: " *"; color: red; }
        /* 理念參考區塊樣式 */
        #philosophy-toggle { margin-top: 20px; text-align: center; }
        #philosophy-toggle button {
            background-color: #4682b4; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em;
        }
        #philosophy-details {
            display: none; /* 預設隱藏 */
            background-color: #e3f2fd; border: 1px solid #90caf9; padding: 15px; margin-top: 10px; border-radius: 5px; font-size: 0.9em;
            text-align: left;
        }
        #philosophy-details h4 { color: #1565c0; margin-top: 5px; margin-bottom: 5px; border-bottom: 1px dotted #1565c0; }
        #philosophy-details ul { padding-left: 20px; margin-top: 5px; }
        #philosophy-details li { margin-bottom: 5px; }
        /* 多選 checkbox 樣式 */
        .checkbox-group {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 5px;
        }
        .checkbox-category {
            font-weight: bold;
            color: #004a99;
            margin-top: 10px;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #ccc;
        }
        .checkbox-category:first-child { margin-top: 0; }
        .checkbox-item {
            display: block;
            font-weight: normal;
            margin: 8px 0;
            cursor: pointer;
            padding-left: 5px;
        }
        .checkbox-item:hover { background-color: #e8f4fc; }
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
            cursor: pointer;
        }
        /* 照片上傳樣式 */
        input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #fafafa;
            cursor: pointer;
        }
        input[type="file"]:hover {
            border-color: #4CAF50;
            background-color: #f0fff0;
        }
        #photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #photo-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        /* 提交中狀態 */
        .submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <script>
        // JavaScript 函數：切換理念詳細內容的顯示狀態
        function togglePhilosophyDetails() {
            var detailsDiv = document.getElementById("philosophy-details");
            var button = document.getElementById("toggle-button");
            if (detailsDiv.style.display === "none") {
                detailsDiv.style.display = "block";
                button.textContent = "隱藏 Jayter 理念細節";
            } else {
                detailsDiv.style.display = "none";
                button.textContent = "點擊查閱 Jayter 理念細節";
            }
        }

        // 影響選項對應的公司規章條文
        const ruleMapping = {
            "破壞團隊信任": "[2] 打破信任或疏忽責任",
            "影響團隊對其依賴性": "[3] 成為團隊可信賴的人",
            "造成人力調度困難": "[11][14] 出勤通知與假期安排",
            "延誤工作進度": "[9] 首要職責是讓公司成功",
            "降低工作品質": "[1] 做好份內的工作",
            "增加他人工作負擔": "[3] 在該出現的時候出現",
            "影響客戶服務品質": "[9] 首要職責是讓公司成功",
            "造成溝通障礙": "[6][7] 溝通義務",
            "問題無法快速解決": "[6] 以最快速方式解決問題",
            "資訊傳遞中斷": "[7] 問題解決前有溝通義務",
            "影響團隊士氣": "[3] 成為團隊可信賴的人",
            "造成工作環境不安": "[安全] 遵守安全政策和程序",
            "存在安全隱患": "[安全] 報告不安全或危險情況",
            "嚴重違反公司規定": "[2] 打破信任將被要求離開",
            "可能涉及法律問題": "[蠢事] 盜竊、洩密、騷擾等"
        };

        // 更新違反規章欄位
        function updateRuleViolated() {
            var checkboxes = document.querySelectorAll('input[name="impact_detail"]:checked');
            var rules = [];
            checkboxes.forEach(function(cb) {
                if (ruleMapping[cb.value]) {
                    rules.push(ruleMapping[cb.value]);
                }
            });
            document.getElementById("rule_violated").value = rules.join("；");
        }

        // 儲存所有已選擇的照片
        var collectedPhotos = [];

        // 照片預覽功能 - 累加模式
        function previewPhotos(input) {
            var preview = document.getElementById('photo-preview');
            var clearBtn = document.getElementById('clear-photos-btn');

            if (input.files && input.files.length > 0) {
                Array.from(input.files).forEach(function(file) {
                    // 檢查是否已存在相同檔案（依名稱和大小判斷）
                    var exists = collectedPhotos.some(function(p) {
                        return p.name === file.name && p.size === file.size;
                    });

                    if (!exists) {
                        collectedPhotos.push(file);

                        var reader = new FileReader();
                        reader.onload = function(e) {
                            var photoContainer = document.createElement('div');
                            photoContainer.style.cssText = 'display:inline-block; position:relative; margin:5px;';

                            var img = document.createElement('img');
                            img.src = e.target.result;
                            img.dataset.fileName = file.name;
                            img.dataset.fileSize = file.size;

                            var removeBtn = document.createElement('span');
                            removeBtn.textContent = '×';
                            removeBtn.style.cssText = 'position:absolute; top:-5px; right:-5px; background:#dc3545; color:white; border-radius:50%; width:20px; height:20px; text-align:center; line-height:20px; cursor:pointer; font-size:14px;';
                            removeBtn.onclick = function() {
                                var fileName = img.dataset.fileName;
                                var fileSize = img.dataset.fileSize;
                                collectedPhotos = collectedPhotos.filter(function(p) {
                                    return !(p.name === fileName && p.size == fileSize);
                                });
                                photoContainer.remove();
                                if (collectedPhotos.length === 0) {
                                    clearBtn.style.display = 'none';
                                }
                            };

                            photoContainer.appendChild(img);
                            photoContainer.appendChild(removeBtn);
                            preview.appendChild(photoContainer);
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // 顯示清除按鈕
                if (collectedPhotos.length > 0) {
                    clearBtn.style.display = 'inline-block';
                }

                // 清空 input 以便再次選擇相同檔案
                input.value = '';
            }
        }

        // 清除所有照片
        function clearAllPhotos() {
            collectedPhotos = [];
            document.getElementById('photo-preview').innerHTML = '';
            document.getElementById('clear-photos-btn').style.display = 'none';
        }

        // 將圖片轉為 Base64
        function fileToBase64(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = function() { resolve(reader.result); };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 提交表單到 Google Sheets
        async function submitForm(event) {
            event.preventDefault();

            var submitBtn = document.querySelector('.submit-btn');
            var originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span>提交中...';

            try {
                // 收集表單資料
                var form = document.getElementById('reportForm');
                var formData = {
                    reporter: form.reporter.value,
                    employee_name: form.employee_name.value,
                    date_observed: form.date_observed.value,
                    time_observed: form.time_observed.value,
                    location: form.location.value,
                    behavior_fact: form.behavior_fact.value,
                    evidence_type: form.evidence_type.value,
                    impact_type: form.impact_type.value,
                    impact_detail: Array.from(document.querySelectorAll('input[name="impact_detail"]:checked')).map(cb => cb.value).join('、'),
                    impact_other: form.impact_other.value,
                    rule_violated: form.rule_violated.value,
                    action_taken: form.action_taken.value,
                    photos: []
                };

                // 處理照片（使用累積的照片陣列）
                if (collectedPhotos.length > 0) {
                    for (var i = 0; i < collectedPhotos.length; i++) {
                        var base64 = await fileToBase64(collectedPhotos[i]);
                        formData.photos.push({
                            name: collectedPhotos[i].name,
                            data: base64
                        });
                    }
                }

                // 發送到 Google Apps Script
                var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz1ZhLZrcjW4n-CLvU9T3hbnu5nVQ8M7kfNZVL4ZguIp8M8OaOkpmorPEYeznkFE0VLtg/exec';

                var response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                alert('提交成功！回報已送出給上層核實。');
                form.reset();
                clearAllPhotos();
                document.getElementById('rule_violated').value = '';

            } catch (error) {
                console.error('提交失敗:', error);
                alert('提交失敗，請稍後再試或聯繫系統管理員。');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // 頁面載入後綁定事件
        document.addEventListener("DOMContentLoaded", function() {
            var checkboxes = document.querySelectorAll('input[name="impact_detail"]');
            checkboxes.forEach(function(cb) {
                cb.addEventListener("change", updateRuleViolated);
            });

            // 照片預覽事件
            document.getElementById('evidence_photo').addEventListener('change', function() {
                previewPhotos(this);
            });

            // 清除所有照片按鈕
            document.getElementById('clear-photos-btn').addEventListener('click', clearAllPhotos);

            // 表單提交事件
            document.getElementById('reportForm').addEventListener('submit', submitForm);
        });
    </script>
</head>
<body>

<div class="report-form">
    <h1>員工行為／績效異常回報表</h1>
    <p style="text-align: center; color: #555;">請在發現異常時，立即客觀填寫並提交。</p>
    
    <form id="reportForm">
        
        <div class="section-header">紀錄基本資訊 (A)</div>
        <label for="reporter" class="required">紀錄人姓名：</label>
        <select id="reporter" name="reporter" required>
            <option value="">-- 請選擇紀錄人 --</option>
            <option value="洪杰">洪杰</option>
            <option value="翁嘉駿">翁嘉駿</option>
            <option value="李紫伶">李紫伶</option>
            <option value="曾紫淇">曾紫淇</option>
            <option value="沈鈴鈺">沈鈴鈺</option>
            <option value="葉子嘉">葉子嘉</option>
            <option value="胡秀綾">胡秀綾</option>
            <option value="楊秀娟">楊秀娟</option>
            <option value="李泓霖">李泓霖</option>
            <option value="李語涵">李語涵</option>
            <option value="吳佩真">吳佩真</option>
            <option value="Maji">Maji</option>
            <option value="Meri">Meri</option>
            <option value="Sari">Sari</option>
            <option value="Anwar">Anwar</option>
            <option value="陳佳雯">陳佳雯</option>
        </select>

        <label for="employee_name" class="required">異常員工姓名：</label>
        <input type="text" id="employee_name" name="employee_name" placeholder="請輸入異常員工姓名" required>

        <label for="date_observed" class="required">觀察日期：</label>
        <input type="date" id="date_observed" name="date_observed" required>

        <label for="time_observed" class="required">觀察時間：</label>
        <input type="time" id="time_observed" name="time_observed" required>
        
        <label for="location">事件地點：</label>
        <select id="location" name="location">
            <option value="">-- 請選擇地點 --</option>
            <option value="進貨區">進貨區</option>
            <option value="退貨區">退貨區</option>
            <option value="撿貨區">撿貨區</option>
            <option value="包貨區">包貨區</option>
            <option value="辦公室">辦公室</option>
            <option value="小會議室">小會議室</option>
            <option value="大會議室">大會議室</option>
            <option value="其他">其他</option>
        </select>

        <div class="section-header">行為與事實描述 (B & E)</div>
        <label for="behavior_fact" class="required">具體行為或績效事實（請客觀描述）：</label>
        <textarea id="behavior_fact" name="behavior_fact" placeholder="範例：在辦公室內大聲咆哮持續約 5 分鐘，或：XX 任務平均處理時間比部門標準慢 40%。" required></textarea>
        
        <label for="evidence_type">證據類型：</label>
        <select id="evidence_type" name="evidence_type">
            <option value="目擊">主管／紀錄人目擊</option>
            <option value="系统数据">系統數據報表</option>
            <option value="通訊記錄">電子郵件／通訊記錄</option>
            <option value="監視器">監視器畫面（需人資或主管核實）</option>
            <option value="證人">證人（需註明姓名）</option>
            <option value="其他">其他 (請註明)</option>
        </select>

        <label>照片佐證（選填）：</label>
        <input type="file" id="evidence_photo" accept="image/*" multiple>
        <div id="photo-preview" style="margin-top: 10px;"></div>
        <button type="button" id="clear-photos-btn" style="display:none; margin-top:10px; padding:8px 15px; background:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer;">清除所有照片</button>

        <div class="section-header">影響判定與規章連結 (C & D)</div>
        <label for="impact_type" class="required">主要影響類別（Jayter 理念）：</label>
        <select id="impact_type" name="impact_type" required>
            <option value="">-- 請選擇最主要的影響類別 --</option>
            <option value="Trust">信任／考勤 (Trust & Attendance)</option>
            <option value="Duties">工作產出與效率 (Job Duties & Goals)</option>
            <option value="Safety">職場環境與安全 (Safety & Concerns)</option>
            <option value="StupidStuff">蠢事 (Stupid Stuff)</option>
        </select>

        <div id="philosophy-toggle">
            <button type="button" id="toggle-button" onclick="togglePhilosophyDetails()">點擊查閱 Jayter 理念細節 (共 15 點)</button>
        </div>
        
        <div id="philosophy-details" style="display: none;">
            <h4>✅ 1. 信任與可靠性 (Trust & Reliability)</h4>
            <ul>
                <li>[1] 我們假設每個人都能夠做好份內的工作，公司在這個假設的基礎上運營。</li>
                <li>[2] 我們會讓那些打破信任或疏忽責任的人離開。</li>
                <li>[3] 成為你的團隊可以信賴的那種人；在該出現的時候出現。</li>
                <li>[4] 按時到公司，準備好工作（交通問題不會在每個週一都出問題）。</li>
                <li>[5] 如果外部工作影響到你這裡的表現，你可能會被要求終止該工作。</li>
            </ul>

            <h4>✅ 2. 溝通與職責 (Communication & Job Duties)</h4>
            <ul>
                <li>[6] 為了公司整體的利益，所有員工都可以也應該向任何人交流，以解決問題最快速的方式。</li>
                <li>[7] 在問題解決之前，自己有義務進行溝通。</li>
                <li>[8] 了解公司對你的期待，這是你的責任（「沒人跟我說過」永遠說不過去）。</li>
                <li>[9] 你的首要職責是讓這家公司成功。</li>
                <li>[10] 如果看到能夠改善工作方式的機會，大聲說出來，就算它不屬於你工作職責（只有自己知道的好主意一文不值）。</li>
            </ul>

            <h4>✅ 3. 考勤與紀律 (Attendance & No Show)</h4>
            <ul>
                <li>[11] 如果不能出勤，盡快通知你的上司，告訴他原因。</li>
                <li>[12] 如果你並不可靠，這個地方不適合你，你將被要求離開。</li>
                <li>[13] 如果你沒電話通知也不來上班，你最好有一個很好的理由，否則你就得離開這裡（一次就夠）。</li>
                <li>[14] 確保提前安排好假期時間，得到上司的批准後再休息。</li>
                <li>[15] 如果你生病了，請在家待著，別讓我們其他人生病。</li>
            </ul>

            <h4>✅ 4. 安全與個人行為 (Safety & Stupid Stuff)</h4>
            <ul>
                <li>[安全] 時刻保持安全意識；遵守所有安全政策和程序。向主管報告不安全或危險情況。</li>
                <li>[蠢事] 盜竊、洩密、騷擾、暴力威脅、非法毒品等，屬於「蠢事」範疇，可能導致立即被要求離開。</li>
            </ul>
        </div>

        <label class="required">對工作／環境的具體影響（可多選）：</label>
        <div class="checkbox-group">
            <div class="checkbox-category">信任與可靠性</div>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="破壞團隊信任"> 破壞團隊信任</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="影響團隊對其依賴性"> 影響團隊對其依賴性</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="造成人力調度困難"> 造成人力調度困難</label>

            <div class="checkbox-category">工作產出與效率</div>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="延誤工作進度"> 延誤工作進度</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="降低工作品質"> 降低工作品質</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="增加他人工作負擔"> 增加他人工作負擔</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="影響客戶服務品質"> 影響客戶服務品質</label>

            <div class="checkbox-category">溝通與協作</div>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="造成溝通障礙"> 造成溝通障礙</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="問題無法快速解決"> 問題無法快速解決</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="資訊傳遞中斷"> 資訊傳遞中斷</label>

            <div class="checkbox-category">職場環境與安全</div>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="影響團隊士氣"> 影響團隊士氣</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="造成工作環境不安"> 造成工作環境不安</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="存在安全隱患"> 存在安全隱患</label>

            <div class="checkbox-category">嚴重違規</div>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="嚴重違反公司規定"> 嚴重違反公司規定</label>
            <label class="checkbox-item"><input type="checkbox" name="impact_detail" value="可能涉及法律問題"> 可能涉及法律問題</label>
        </div>

        <label for="impact_other">補充說明（選填）：</label>
        <input type="text" id="impact_other" name="impact_other" placeholder="如需補充具體情況可在此填寫">

        <label for="rule_violated">違反的公司規章或標準條文：</label>
        <input type="text" id="rule_violated" name="rule_violated" readonly style="background-color: #f0f0f0;" placeholder="（依據上方勾選自動帶入）">

        <div class="section-header">後續處理與核實 (F)</div>
        <label for="action_taken">紀錄人當下已採取行動：</label>
        <input type="text" id="action_taken" name="action_taken" placeholder="例如：已進行口頭提醒，或：已要求立即停止該行為。">
        
        <input type="submit" value="提交回報給上層核實" class="submit-btn">
    </form>
</div>

</body>
</html>